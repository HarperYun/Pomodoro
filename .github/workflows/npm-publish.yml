# This workflow will run tests using node and then publish a package to GitHub Packages when a release is created
# For more information see: https://help.github.com/actions/language-and-framework-guides/publishing-nodejs-packages

# name: Node.js Package

# on:
#   release:
#     types: [created]

# jobs:
#   build:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v3
#       - uses: actions/setup-node@v3
#         with:
#           node-version: 16
#       - run: npm ci
#       - run: npm test

#   publish-npm:
#     needs: build
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v3
#       - uses: actions/setup-node@v3
#         with:
#           node-version: 16
#           registry-url: https://registry.npmjs.org/
#       - run: npm ci
#       - run: npm publish
#         env:
#           NODE_AUTH_TOKEN: ${{secrets.npm_token}}

# # è§¸ç™¼å·¥ä½œæµç¨‹çš„äº‹ä»¶
# on:
#   push:
#     branches:
#       - main
#       - "releases/**"
#       - dev

# # æŒ‰é †åºåŸ·è¡Œä½œæ¥­
# jobs:
#   publish-gpr:
#     # æŒ‡å®šçš„åŸ·è¡Œå™¨ç’°å¢ƒ
#     runs-on: ubuntu-latest
#     # è¨­å®š node ç‰ˆæœ¬
#     strategy:
#       matrix:
#         node-version: [16]
#     steps:
#       # æ‹‰å– github å€‰åº«ç¨‹å¼ç¢¼
#       - uses: actions/checkout@v3
#       # è¨­å®š node ç’°å¢ƒ
#       - uses: actions/setup-node@v3
#         with:
#           node-version: ${{ matrix.node-version }}
#           # è¨­å®šç™¼åŒ… npm åœ°å€å€‰åº«
#           registry-url: https://registry.npmjs.org
#       # å®‰è£ä¾è³´ï¼Œç›¸ç•¶æ–¼ npm ci
#       - name: Install dependencies ğŸ“¦ï¸
#         run: npm install
#       # åŸ·è¡Œæ§‹å»ºæ­¥é©Ÿ
#       - name: æ§‹å»º
#         run: |
#           npm run build
#       # åŸ·è¡Œéƒ¨ç½²
#       - name: éƒ¨ç½²
#         # é€™å€‹ action æœƒæ ¹æ“šé…ç½®è‡ªå‹•æ¨é€ç¨‹å¼ç¢¼åˆ°æŒ‡å®šåˆ†æ”¯
#         uses: JamesIves/github-pages-deploy-action@releases/v3
#         with:
#           # æŒ‡å®šé‡‘é‘°ï¼Œå³åœ¨ç¬¬ä¸€æ­¥ä¸­è¨­å®šçš„
#           ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
#           # æŒ‡å®šæ¨é€åˆ°çš„é ç«¯åˆ†æ”¯
#           BRANCH: pages
#           # æŒ‡å®šæ§‹å»ºä¹‹å¾Œçš„ç”¢ç‰©è¦æ¨é€å“ªå€‹ç›®éŒ„çš„ç¨‹å¼ç¢¼
#           FOLDER: 
#       - run: npm publish
#         env:
#           # å‰›å‰›è¨­å®šçš„ NPM_TOKEN
#           NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

# link: https://sujingjhong.com/posts/how-to-deploy-hugo-automatically-with-github-actions/
# author: lisez <mm4324@gmail.com>
name: Auto publish to public site

# åªæœ‰æ¨é€åˆ° master æ‰è‡ªå‹•åŒ–
on:
  push:
    branches: 
    - master
    - main
    - "releases/**"
    - dev

jobs:
  hugo-publish:
    name: publish content to public site
    runs-on: ubuntu-latest
    steps:
      # ä½¿ç”¨ç•¶å‰çš„ repo
      - name: checkout private repo
        uses: actions/checkout@v3
        with:
          # å› ç‚ºç›®å‰çš„ repo æœ‰ä½¿ç”¨åˆ° submoduleï¼Œæ‰€ä»¥ submodule ä¹Ÿè¦ä¸€ä½µåŒæ­¥	
          # ä¸ç„¶åŸæœ¬çš„ repo æ˜¯æ²’æœ‰ submodule çš„å…§å®¹
          submodules: true
          token: ${{ secrets.GITHUB_PAT }}

      # æˆ‘çš„å…¬é–‹ç¶²ç«™æ˜¯æ”¾ç½®åœ¨å¦ä¸€å€‹ repo æ‰€ä»¥é€™è£¡ä¹Ÿè¦ clone ä¸€ä»½ä¸‹ä¾†è™•ç†
      # å› ç‚ºæˆ‘ Hugo é è¨­æ˜¯ç”¢ç”Ÿæª”æ¡ˆåˆ° public è³‡æ–™å¤¾ï¼Œæ‰€ä»¥é€™é‚Šæˆ‘ä¹Ÿæ˜¯ clone åˆ°é‚£è£¡
      - name: checkout public repo
        uses: actions/checkout@v3
        with:
          path: public
          # è¨˜å¾—å»ç”¢ç”Ÿä¸€æŠŠ personal access token æ”¾åˆ° repo çš„ secrets è£¡
          # ç„¶å¾Œæˆ‘ secrets è£¡çš„åç¨±å°±å« GITHUB_PATï¼Œç”¨åˆ¥çš„åç¨±çš„è©±è¨˜å¾—æ”¹æ‰
          # åƒè€ƒ https://help.github.com/en/actions/automating-your-workflow-with-github-actions/authenticating-with-the-github_token
          token: ${{ secrets.GITHUB_PAT }}

      # ä½¿ç”¨åˆ¥äººåšå¥½çš„ Hugo Actions
      - name: setup hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: latest
          extended: true

      # é–‹å§‹ç”¨ Hugo ç”¢ç”Ÿæª”æ¡ˆå›‰
      - name: build content to public site
        working-directory: ./
        # --cleanDestinationDir æ¸…é™¤èˆŠæª”æ¡ˆ
        run: hugo --minify --gc --cleanDestinationDir

      # å°‡æª”æ¡ˆ commit åˆ° ç¶²ç«™ repo
      - name: deploy and publish updates
        working-directory: ./public
        # user.email é‚„æœ‰ user.name å¯ä»¥å–è‡ªå·±å–œæ­¡çš„ï¼Œä¸€å®šè¦è¨­å®šä¸ç„¶æœƒå‡ºéŒ¯
        run: |
          # ç•¶ git æœ‰æ›´å‹•æ™‚æ‰é€²è¡Œå‹•ä½œ
          if [[ `git status --porcelain` ]]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add . -A
            git commit -m "[chore] Auto publish"
            git push origin
          else
            echo "content no changes"
          fi